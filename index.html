<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Fitness challenge</title>
	<link rel="icon" type="image/x-icon" href="/assets/icon.png">
	<link rel="apple-touch-icon" sizes="128x128" href="/assets/icon.png">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            padding: 0;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        #main-container {
            max-width: 800px;
        }
		.section {
			padding-top: 66px;
		}

		.calendar-day {
			min-height: 100px;
			border: 1px solid #ddd;
			position: relative;
			padding: 20px 5px;
			opacity: 0.8
		}
		
		.calendar-row div:nth-last-of-type(1), 
		.calendar-row div:nth-last-of-type(2) {
			background-color: #EEE;
		}
		
		.calendar-day img {
			max-width: 80%;
			max-height: 60px;
			display: block;
			margin: 0 auto;
		}
		
		.calendar-day.calendar-day-today img {
			border: 1px solid #000;
		}
		
		.calendar-day.calendar-day-future {
			opacity: 0.3;
		}
		
		.calendar-day.calendar-day-today {
			opacity: 1;
			font-weight: bold;
		}
		
		.calendar-day .date {
			position: absolute;
			top: 5px;
			right: 5px;
			font-size: 0.85em;
		}

        .form-group {
            margin-bottom: 15px;
        }
        .array-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .array-item input {
            flex: 1;
            margin-right: 5px;
        }
    </style>
</head>
<body data-bs-spy="scroll" data-bs-target=".navbar" data-bs-offset="0">


    <!--- Navbar --->
    <nav class="navbar navbar-expand bg-light navbar-light fixed-top">
      <div class="container-fluid">
	<h4 class="text-danger text-center text-uppercase mt-2" style="position:absolute;transform: rotate(-45deg); width: 100px;z-index:1000;">Beta</h4>
        <a class="navbar-brand" href="#challenge">
            <img src="/assets/logo.webp" alt="Avatar Logo" style="width:40px;" class="rounded-pill"> 
        </a>
          <ul class="navbar-nav mx-auto">
            <li class="nav-item">
				<a class="nav-link" href="#challenge">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-house" viewBox="0 0 16 16">
					  <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z"/>
					</svg>
					<span class="d-none d-sm-inline">Daily challenge</span>
				</a>
            </li>
            <li class="nav-item">
				<a class="nav-link" href="#history">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar3" viewBox="0 0 16 16">
						<path d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2M1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857z"/>
					  <path d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
					</svg>
					<span class="d-none d-sm-inline">History</span>
				</a>
            </li>
            <li class="nav-item">
				<a class="nav-link" href="#challengelist">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-card-list" viewBox="0 0 16 16">
					  <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2z"/>
					  <path d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8m0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m0 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-1-5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0M4 8a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0m0 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/>
					</svg> 
					<span class="d-none d-sm-inline">Overview of challenges</span>
				</a>
            </li>
            <li class="nav-item">
				<a class="nav-link" href="#settings">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sliders2" viewBox="0 0 16 16">
					  <path fill-rule="evenodd" d="M10.5 1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V4H1.5a.5.5 0 0 1 0-1H10V1.5a.5.5 0 0 1 .5-.5M12 3.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-6.5 2A.5.5 0 0 1 6 6v1.5h8.5a.5.5 0 0 1 0 1H6V10a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5M1 8a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2A.5.5 0 0 1 1 8m9.5 2a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V13H1.5a.5.5 0 0 1 0-1H10v-1.5a.5.5 0 0 1 .5-.5m1.5 2.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/>
					</svg>
					<span class="d-none d-sm-inline">Settings</span>
				</a>
            </li>
          </ul>
      </div>
    </nav>

    <!--- Challenge --->
    <div id="challenge" class="section container-fluid bg-light bg-gradient pt-5 min-vh-100">
        <div class="container px-4 py-5 mt-5" id="main-container">
            
        </div>
    </div>

    <!--- History --->
    <div id="history" class="section container-fluid bg-dark text-white py-5 min-vh-100">
        <h1>History</h1>
		<div  id="history" class="container bg-light text-dark border rounded-2 p-4">
			<div class="container-fluid" id="history-choosers"></div>
			<div class="container-fluid" id="history-calendar"></div>
		</div>
    </div>

    <!--- Challenges --->
    <div id="challengelist" class="section container-fluid bg-secondary pt-5 min-vh-100">
        <h1>Overview of challenges</h1>
        <div class="container mt-5 bg-light border rounded-2 p-4">
        	<div class="row">
        		<div class="col-lg-3 col-md-12">
        			<canvas id="circleDiagram"></canvas>
        		</div>
        		<div id="challengelist-container" class="col"></div>
        	</div>
        </div>
    </div>

	<!--- Settings --->
	<div id="settings" class="section container-fluid bg-dark bg-gradient text-white pt-5 min-vh-100">
        <h3 class="text-center">Settings</h3>
        <form id="settingsForm" class="container text-center mt-5" >
            <div class="form-group">
                <label>Participants</label>
                <div id="participantsContainer">
                    <div class="array-item">
                        <input type="text" class="form-control participant-input" placeholder="Enter participant name">
                        <button type="button" class="btn btn-danger btn-sm remove-participant-item">-</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-sm mt-2" id="addParticipantItem">Add Participant</button>
            </div>
            <button type="button" class="btn btn-primary" id="saveSettings">Save</button>
            <button type="button" class="btn btn-secondary" id="resetSettings">Reset</button>
        </form>
    </div>
	
	
	<!-- Link to Bootstrap JS and Popper.js and Chart.js-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars/dist/handlebars.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    
	
	<!----------------------------------
	|||      participant-container
	------------------------------------>
    <script id="template-participant-container" type="text/x-handlebars-template">
		<h2 class="pb-2 border-bottom mt-5">{{name}}</h2>
		<div class="row g-0" id="participant-{{number}}">
			<div class="col m-2">
				{{> daycard class='today' dayname='Today' date='...'}}
			</div>
			<div class="col m-2">
				{{> daycard class='tomorrow' dayname='Tomorrow' date='...'}}
			</div>
		</div>
    </script> 
	

	<!-----------------------------------
	|||         card-placeholder      |||
	------------------------------------>
    <script id="template-daycard" type="text/x-handlebars-template">
		<div class="card {{class}}-card text-center">
			<img alt="unknown" src="/assets/unknown.webp" class="card-img-top"/>
			<div class="card-body">
				<p class="card-text"></p>
			</div>
			<div class="card-footer display-6">
				{{dayname}}
			</div>
		</div>
    </script>
	


	<!-----------------------------------
	|||      calendar-main           |||
	------------------------------------>
    <script id="template-calendar-main" type="text/x-handlebars-template">
		 <div class="row row-cols-7 text-center">
			<!-- Calendar header -->
			<div class="col h4">Mon</div>
			<div class="col h4">Tue</div>
			<div class="col h4">Wed</div>
			<div class="col h4">Thu</div>
			<div class="col h4">Fri</div>
			<div class="col h4">Sat</div>
			<div class="col h4">Sun</div>
		</div>
		<div class="row row-cols-7 calendar-row">
			{{#each before}}
				<div class="col calendar-day"></div>
			{{/each}}
			{{#each days}}
				{{#unless date.weekdayNum}}
					</div><div class="row row-cols-7 calendar-row">
				{{/unless}}
				{{> calendar-day this}}
			{{/each}}
			{{#each after}}
				<div class="col calendar-day"></div>
			{{/each}}
		</div>
    </script>
	<!-----------------------------------
	|||        calendar-day           |||
	------------------------------------>
    <script id="calendar-day" type="text/x-handlebars-template">
		<div class="col pt-5 pt-md-4 calendar-day{{#if date.isToday}} border-primary calendar-day-today{{/if}}{{#if date.isTomorrow}} calendar-day-tomorrow{{/if}}{{#if date.isFuture}} calendar-day-future{{/if}}">
			<span class="date">{{date.shortString}}</span>
			<a data-toggle="tooltip" data-placement="bottom" title="{{element.name}}">
				<img src="{{element.imgUrl}}" alt="{{element.name}}" class="rounded-circle" style="border-color: {{element.color}}; border-style:solid;border-width: 5px;"/>
			</a>
		</div>
    </script>

	<!---------------------------------------
	|||   history-choosers
	---------------------------------------->
    <script id="template-history-choosers" type="text/x-handlebars-template">
		<nav aria-label="Participant">
			<ul class="pagination pagination-sm justify-content-end">
				{{#each participants}}
					<li id="history-participant-button-{{@index}}" class="history-participant-button page-item"><a class="page-link" href="javascript:clickHistoryParticipant({{@index}});">{{this}}</a></li>
				{{/each}}
			</ul>
		</nav>
			<nav aria-label="Number of days">
			  <ul class="pagination pagination-sm justify-content-end">
			  	{{#each dayChoosers}}
					<li id="history-days-button-{{this}}"  class="history-days-button page-item"><a class="page-link" href="javascript:clickHistoryDays({{this}});">{{this}}</a></li>
				{{/each}}
			  </ul>
			</nav>
    </script>

    <!----------------------------------
    |||      challengelist-container          |||
    ------------------------------------>
    <script id="template-challengelist-container" type="text/x-handlebars-template">
    	<div class="row">
	        {{#each this}}
	          {{> challenge-description-card this}}
	        {{/each}}
    	</div>
    </script>

    <!-----------------------------------
    |||   challenge-description-card  |||
    ------------------------------------>
    <script id="challenge-description-card" type="text/x-handlebars-template">
        <div class="col-lg-3 col-md-6 col-sm-6 my-2">
            <div class="card h-100">
              <div class="card-header" style="background:{{color}};">
                <h5 class="card-title">{{name}}</h3>
              </div>
                <img alt="{{name}}" src="{{imgUrl}}" class="card-img-top rounded-circle w-50 mx-auto mt-3"/>
              <div class="card-body">
                <h6>Frequency <small>({{chance}})</small></h6>
                <p class="card-text">{{frequencytext}}</p>
                <h6>Description</h6>
                <p class="card-text">{{description}}</p>
              </div>
            </div>
        </div>
    </script>


	<!----------------------------------
	|||      Settings functionality   |||
	------------------------------------>
	<script>
        const defaultSettings = {
            participants: ['Marcher', 'Mathias', 'Nord']
        };
        var globalSettings = {};
		
		function saveSettings() {
            const participantInputs = document.querySelectorAll('.participant-input');
            const participantValues = Array.from(participantInputs).map(input => input.value);
            const settings = {
                //username: document.getElementById('username').value,
                //volume: document.getElementById('volume').value,
                //theme: document.getElementById('theme').value,
                participants: participantValues
            };
            document.cookie = `settings=${JSON.stringify(settings)};path=/;max-age=31536000`;
            
            window.location.reload();
        }

        function loadSettings() {
            const cookie = document.cookie.split('; ').find(row => row.startsWith('settings='));
            const settings = cookie ? JSON.parse(cookie.split('=')[1]) : defaultSettings;

            //document.getElementById('username').value = settings.username;
            //document.getElementById('volume').value = settings.volume;
            //document.getElementById('theme').value = settings.theme;

            const participantsContainer = document.getElementById('participantsContainer');
            participantsContainer.innerHTML = '';
            settings.participants.forEach(value => {
                addParticipantItem(value);
            });
            globalSettings = settings;
        }

        function addParticipantItem(value = '') {
            const participantsContainer = document.getElementById('participantsContainer');
            const div = document.createElement('div');
            div.className = 'array-item';
            div.innerHTML = `
                <input type="text" class="form-control participant-input" value="${value}" placeholder="Enter participant name">
                <button type="button" class="btn btn-danger btn-sm remove-participant-item">-</button>
            `;
            div.querySelector('.remove-participant-item').addEventListener('click', () => div.remove());
            participantsContainer.appendChild(div);
        }

        document.getElementById('addParticipantItem').addEventListener('click', () => addParticipantItem());
        document.getElementById('saveSettings').addEventListener('click', saveSettings);
        document.getElementById('resetSettings').addEventListener('click', loadSettings);
    </script>

	<!----------------------------------
	|||      Render functionality    |||
	------------------------------------>
    <script>
		function renderTemplates(){
			renderParticipant();
			renderHistory();
		}
		function renderParticipant(){
			Handlebars.registerPartial("daycard", document.getElementById('template-daycard').innerHTML);

            // Compile the Handlebars template
            const templateSource = document.getElementById('template-participant-container').innerHTML;
            const template = Handlebars.compile(templateSource);
            
            
            // Pass the data to the template
			var compiledHtml = '';
            for (var i = 0; i < globalSettings.participants.length; i++) {
            	compiledHtml += template({number:i+1, name:globalSettings.participants[i]});
            }
            
            // Insert the compiled HTML into the page
            document.getElementById('main-container').innerHTML = compiledHtml;
		}
		function renderHistory(){
            // Compile the Handlebars template
            const templateSource = document.getElementById('template-history-choosers').innerHTML;
            const template = Handlebars.compile(templateSource);
            
            
            // Pass the data to the template
			var compiledHtml =  template({participants: globalSettings.participants, dayChoosers: [30, 90, 180, 365]});
            
            // Insert the compiled HTML into the page
            document.getElementById('history-choosers').innerHTML = compiledHtml;
		}


    </script>


	<!----------------------------------
	|||        Fetch functionality    |||
	------------------------------------>
    <script>
		async function fetchData(){
			const today = new Date();
			const tomorrow =  new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);

            for (var i = 0; i < globalSettings.participants.length; i++) {
            	fetchCard(i+1, globalSettings.participants[i], 'today', today);
            	fetchCard(i+1, globalSettings.participants[i], 'tomorrow', tomorrow);
            }
		}

		async function fetchCard(id, participant, dayname, date){
			try {
                const response = await fetch('/api/lists/challenges/element?userseed='+participant+'&date='+date.toISOString().split('T')[0]);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                const container = document.getElementById('participant-'+id).getElementsByClassName(dayname+'-card')[0];
								
				container.getElementsByClassName('card-text')[0].innerHTML = data.element.name;
				//container.getElementsByClassName('card-footer')[0].innerHTML = data.date.mediumString;
				container.getElementsByClassName('card-img-top')[0].src = data.element.imgUrl;
				
            } catch (error) {
                console.error('There has been a problem with your fetch operation:', error);
            }
		}

		async function fetchHistory(){
			Handlebars.registerPartial("calendar-day", document.getElementById('calendar-day').innerHTML);
			let participant = globalSettings.participants[currentHistoryParticipantId];
			try {
				const todate = new Date();
				const fromdate = new Date();
				fromdate.setDate(fromdate.getDate() - currentHistoryDays);
                const response = await fetch('/api/lists/challenges/history?userseed='+participant+'&fromdate='+fromdate.toISOString().split('T')[0]+'&todate='+todate.toISOString().split('T')[0]);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = (await response.json());
                
                // Compile the Handlebars template
                const templateSource = document.getElementById('template-calendar-main').innerHTML;
                const template = Handlebars.compile(templateSource);
                
                // Pass the data to the template
				const numBefore = data[0].date.weekdayNum;
				const numAfter = 6-data[data.length-1].date.weekdayNum;
                const compiledHtml = template({before: [...Array(numBefore).keys()], days: data, after: [...Array(numAfter).keys()]});
                
                // Insert the compiled HTML into the page
                document.getElementById('history-calendar').innerHTML = compiledHtml;
                
                //Activate "participant" button
				let participantButtons = document.getElementsByClassName('history-participant-button');
				for (var i = 0; i < participantButtons.length; i++) {
					participantButtons[i].classList.remove("active");
				}
				document.getElementById('history-participant-button-'+currentHistoryParticipantId).classList.add("active");

                //Activate "days" button
				let daysButtons = document.getElementsByClassName('history-days-button');
				for (var i = 0; i < daysButtons.length; i++) {
					daysButtons[i].classList.remove("active");
				}
				document.getElementById('history-days-button-'+currentHistoryDays).classList.add("active");
				
            } catch (error) {
                console.error('There has been a problem with your fetch operation:', error);
            }
		}
        
        async function fetchChallengeList() {
        	Handlebars.registerPartial("challenge-description-card", document.getElementById('challenge-description-card').innerHTML);
            try {
                const response = await fetch('/api/lists/challenges');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                // Compile the Handlebars template
                const templateSource = document.getElementById('template-challengelist-container').innerHTML;
                const template = Handlebars.compile(templateSource);
                
                // Pass the data to the template
                const compiledHtml = template(data.elements);
                
                // Insert the compiled HTML into the page
                document.getElementById('challengelist-container').innerHTML = compiledHtml;
                drawCircleDiagram(data.elements);
            } catch (error) {
                console.error('There has been a problem with your fetch operation:', error);
            }
        }

        function drawCircleDiagram(data){
	        const ctx = document.getElementById('circleDiagram').getContext('2d');
	        new Chart(ctx, {
	            type: 'pie',
	            data: {
	                labels: data.map(item => item.name),
	                datasets: [{
	                    data: data.map(item => item.weight),
	                    backgroundColor: data.map(item => item.color),
	                }]
	            },
	            options: {
	                responsive: true,
	                plugins: {
	                    tooltip: {
	                        enabled: true
	                    },
	                    legend: {
	                    	display: false
	                    }
	                }
	            }
	        });
        }

		function clickHistoryParticipant(participantId){
			currentHistoryParticipantId = participantId;
			fetchHistory();
		}

		function clickHistoryDays(days){
			currentHistoryDays = days;
			fetchHistory();
		}
	</script>


    <script>
    	let currentHistoryParticipantId = 0, currentHistoryDays = 30;
		function loadMain(){ 
			loadSettings();
			renderTemplates();
			fetchData();
			fetchHistory();
			fetchChallengeList();
		}
        // Display content when the page loads
        document.addEventListener('DOMContentLoaded', loadMain);
    </script>
</body>
</html>
